{% extends 'base.html' %}
{% load static %}

{% block title %}Calendario - Calendario Judicial{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-calendar3"></i>
            Calendario de Plazos Judiciales
        </h1>
    </div>
</div>

<!-- Filtros Avanzados -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel"></i>
                        Filtros Avanzados
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" id="toggle-filters">
                        <i class="bi bi-chevron-up" id="filter-icon"></i>
                        <span id="filter-text">Ocultar</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form method="get" id="filtros-form">
                    <!-- Búsqueda General -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="{{ form_filtro.busqueda.id_for_label }}" class="form-label">
                                {{ form_filtro.busqueda.label }}
                            </label>
                            <div class="position-relative">
                                {{ form_filtro.busqueda }}
                                <div id="search-results"></div>
                            </div>
                            <div class="form-text">Busca en RUT, clave de cliente y observaciones</div>
                        </div>
                    </div>
                    
                    <!-- Filtros Avanzados de Búsqueda -->
                    <div class="advanced-filters" id="advanced-filters" style="display: none;">
                        <h6 class="mb-3">
                            <i class="bi bi-gear"></i>
                            Opciones de Búsqueda
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form_filtro.busqueda_exacta }}
                                    <label class="form-check-label" for="{{ form_filtro.busqueda_exacta.id_for_label }}">
                                        {{ form_filtro.busqueda_exacta.label }}
                                    </label>
                                    <div class="form-text">Buscar coincidencias exactas en lugar de parciales</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form_filtro.incluir_observaciones }}
                                    <label class="form-check-label" for="{{ form_filtro.incluir_observaciones.id_for_label }}">
                                        {{ form_filtro.incluir_observaciones.label }}
                                    </label>
                                    <div class="form-text">Incluir observaciones en la búsqueda</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botón para mostrar filtros avanzados -->
                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="toggle-advanced-filters">
                            <i class="bi bi-gear"></i>
                            <span id="advanced-text">Mostrar opciones avanzadas</span>
                        </button>
                    </div>
                    
                    <!-- Filtros Básicos -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="{{ form_filtro.tipo_documento.id_for_label }}" class="form-label">
                                {{ form_filtro.tipo_documento.label }}
                            </label>
                            {{ form_filtro.tipo_documento }}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form_filtro.procedimiento.id_for_label }}" class="form-label">
                                {{ form_filtro.procedimiento.label }}
                            </label>
                            {{ form_filtro.procedimiento }}
                        </div>
                        
                        <div class="col-md-2">
                            <label for="{{ form_filtro.estado.id_for_label }}" class="form-label">
                                {{ form_filtro.estado.label }}
                            </label>
                            {{ form_filtro.estado }}
                        </div>
                        
                        <div class="col-md-2">
                            <label for="{{ form_filtro.fecha_desde.id_for_label }}" class="form-label">
                                {{ form_filtro.fecha_desde.label }}
                            </label>
                            {{ form_filtro.fecha_desde }}
                        </div>
                        
                        <div class="col-md-2">
                            <label for="{{ form_filtro.fecha_hasta.id_for_label }}" class="form-label">
                                {{ form_filtro.fecha_hasta.label }}
                            </label>
                            {{ form_filtro.fecha_hasta }}
                        </div>
                    </div>
                    
                    <!-- Búsqueda Específica -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="{{ form_filtro.rol.id_for_label }}" class="form-label">
                                {{ form_filtro.rol.label }}
                            </label>
                            {{ form_filtro.rol }}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form_filtro.rut_cliente.id_for_label }}" class="form-label">
                                {{ form_filtro.rut_cliente.label }}
                            </label>
                            {{ form_filtro.rut_cliente }}
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="{{ form_filtro.clave_cliente.id_for_label }}" class="form-label">
                                {{ form_filtro.clave_cliente.label }}
                            </label>
                            {{ form_filtro.clave_cliente }}
                        </div>
                    </div>
                    
                    <!-- Filtros Especiales y Ordenamiento -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <div class="form-check">
                                {{ form_filtro.solo_urgentes }}
                                <label class="form-check-label" for="{{ form_filtro.solo_urgentes.id_for_label }}">
                                    {{ form_filtro.solo_urgentes.label }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="form-check">
                                {{ form_filtro.solo_vencidos }}
                                <label class="form-check-label" for="{{ form_filtro.solo_vencidos.id_for_label }}">
                                    {{ form_filtro.solo_vencidos.label }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form_filtro.ordenar_por.id_for_label }}" class="form-label">
                                Ordenar por
                            </label>
                            {{ form_filtro.ordenar_por }}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form_filtro.direccion_orden.id_for_label }}" class="form-label">
                                Dirección
                            </label>
                            {{ form_filtro.direccion_orden }}
                        </div>
                    </div>
                    
                    <!-- Botones de Acción -->
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i>
                                Filtrar
                            </button>
                            <a href="{% url 'calendario' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i>
                                Limpiar
                            </a>
                            <button type="button" class="btn btn-outline-info" id="toggle-advanced">
                                <i class="bi bi-gear"></i>
                                Filtros Avanzados
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Resumen de resultados -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ total_plazos }} plazos
        </div>
    </div>
</div>

<!-- Tabla de plazos -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table"></i>
                    Lista de Plazos
                </h5>
                <div class="btn-group">
                    <a href="{% url 'crear_plazo' %}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i>
                        Nuevo Plazo
                    </a>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-download"></i>
                            Exportar
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'exportar_pdf' %}?{{ request.GET.urlencode }}">
                                <i class="bi bi-file-pdf"></i> PDF
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'exportar_ics' %}?{{ request.GET.urlencode }}">
                                <i class="bi bi-calendar-event"></i> iCalendar
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                {% if page_obj %}
                    <!-- Botones de Exportación -->
                    <div class="p-3 border-bottom bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="text-muted">
                                    <span id="selected-count">0</span> plazos seleccionados
                                </span>
                            </div>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="export-selected-pdf" disabled>
                                    <i class="bi bi-file-pdf"></i>
                                    Exportar PDF Seleccionados
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" id="export-selected-ics" disabled>
                                    <i class="bi bi-calendar-event"></i>
                                    Exportar ICS Seleccionados
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="export-all-pdf">
                                    <i class="bi bi-file-pdf"></i>
                                    Exportar Todos PDF
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="export-all-ics">
                                    <i class="bi bi-calendar-event"></i>
                                    Exportar Todos ICS
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" id="select-all" class="form-check-input">
                                    </th>
                                    <th>ID</th>
                                    <th>Tipo Documento</th>
                                    <th>Procedimiento</th>
                                    <th>Rol</th>
                                    <th>RUT Cliente</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Días Restantes</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plazo in page_obj %}
                                <tr class="{% if plazo.estado == 'vencido' %}vencido{% elif plazo.dias_restantes and plazo.dias_restantes <= 3 %}urgente{% endif %}">
                                    <td>
                                        <input type="checkbox" name="plazos_seleccionados" value="{{ plazo.id }}" class="form-check-input plazo-checkbox">
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">#{{ plazo.id }}</span>
                                    </td>
                                    <td>
                                        <i class="bi bi-file-text"></i>
                                        {{ plazo.get_tipo_documento_display }}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ plazo.get_procedimiento_display }}</span>
                                    </td>
                                    <td>
                                        <code>{{ plazo.rol }}</code>
                                    </td>
                                    <td>
                                        <code>{{ plazo.rut_cliente }}</code>
                                    </td>
                                    <td>
                                        {{ plazo.fecha_inicio|date:"d/m/Y" }}
                                        <br>
                                        <small class="text-muted">{{ plazo.fecha_inicio|date:"l" }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ plazo.fecha_vencimiento|date:"d/m/Y" }}</strong>
                                        <br>
                                        <small class="text-muted">{{ plazo.fecha_vencimiento|date:"l" }}</small>
                                    </td>
                                    <td>
                                        {% if plazo.dias_restantes is not None %}
                                            <span class="badge {% if plazo.dias_restantes <= 0 %}bg-danger{% elif plazo.dias_restantes <= 3 %}bg-warning{% else %}bg-success{% endif %}">
                                                {{ plazo.dias_restantes }} días
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge estado-badge bg-{% if plazo.estado == 'vencido' %}danger{% elif plazo.estado == 'corriendo' %}info{% elif plazo.estado == 'esperando_proveido' %}warning{% elif plazo.estado == 'suspendido' %}secondary{% else %}primary{% endif %}">
                                            {{ plazo.get_estado_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'detalle_plazo' plazo.id %}" class="btn btn-outline-primary btn-sm" title="Ver detalle">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{% url 'editar_plazo' plazo.id %}" class="btn btn-outline-warning btn-sm" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{% url 'eliminar_plazo' plazo.id %}" class="btn btn-outline-danger btn-sm" title="Eliminar" onclick="return confirmarEliminacion('¿Está seguro de que desea eliminar este plazo?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">No se encontraron plazos</h5>
                        <p class="text-muted">No hay plazos que coincidan con los filtros seleccionados.</p>
                        <a href="{% url 'crear_plazo' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i>
                            Crear Primer Plazo
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Paginación -->
{% if page_obj.has_other_pages %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Navegación de páginas">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('#filtros-form');
        const busquedaInput = document.getElementById('busqueda-input');
        const rutInput = document.getElementById('rut-input');
        const claveInput = document.getElementById('clave-input');
        const toggleAdvanced = document.getElementById('toggle-advanced');
        const advancedFilters = document.querySelectorAll('.col-md-3, .col-md-6');
        
        let searchTimeout;
        
        // Búsqueda en tiempo real
        function setupRealTimeSearch(input, delay = 500) {
            input.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    form.submit();
                }, delay);
            });
        }
        
        // Configurar búsqueda en tiempo real
        if (busquedaInput) setupRealTimeSearch(busquedaInput, 300);
        if (rutInput) setupRealTimeSearch(rutInput, 500);
        if (claveInput) setupRealTimeSearch(claveInput, 500);
        
        // Auto-submit para selects
        const selects = form.querySelectorAll('select');
        selects.forEach(select => {
            select.addEventListener('change', function() {
                form.submit();
            });
        });
        
        // Toggle filtros avanzados
        if (toggleAdvanced) {
            // Ocultar filtros avanzados inicialmente
            advancedFilters.forEach(filter => {
                if (filter.querySelector('input[type="text"]') || 
                    filter.querySelector('select[name="ordenar_por"]') ||
                    filter.querySelector('select[name="direccion_orden"]')) {
                    filter.style.display = 'none';
                }
            });
            
            let advancedVisible = false;
            
            toggleAdvanced.addEventListener('click', function() {
                advancedVisible = !advancedVisible;
                
                advancedFilters.forEach(filter => {
                    if (filter.querySelector('input[type="text"]') || 
                        filter.querySelector('select[name="ordenar_por"]') ||
                        filter.querySelector('select[name="direccion_orden"]')) {
                        filter.style.display = advancedVisible ? 'block' : 'none';
                    }
                });
                
                this.innerHTML = advancedVisible ? 
                    '<i class="bi bi-gear-fill"></i> Ocultar Filtros' : 
                    '<i class="bi bi-gear"></i> Filtros Avanzados';
            });
        }
        
        // Validación de RUT en tiempo real
        if (rutInput) {
            rutInput.addEventListener('input', function(e) {
                let rut = e.target.value.replace(/[^0-9kK]/g, '');
                if (rut.length > 1) {
                    let rutFormateado = rut.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + rut.slice(-1);
                    e.target.value = rutFormateado;
                }
            });
        }
        
        // Atajos de teclado
        document.addEventListener('keydown', function(e) {
            // Ctrl + F para enfocar búsqueda
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                if (busquedaInput) {
                    busquedaInput.focus();
                    busquedaInput.select();
                }
            }
            
            // Escape para limpiar filtros
            if (e.key === 'Escape') {
                window.location.href = '{% url "calendario" %}';
            }
        });
        
        // Mostrar contador de caracteres
        if (busquedaInput) {
            const counter = document.createElement('small');
            counter.className = 'text-muted';
            counter.style.display = 'block';
            busquedaInput.parentNode.appendChild(counter);
            
            busquedaInput.addEventListener('input', function() {
                const length = this.value.length;
                counter.textContent = `${length} caracteres`;
                counter.className = length > 0 ? 'text-info' : 'text-muted';
            });
        }
        
        // Toggle para colapsar filtros
        const toggleButton = document.getElementById('toggle-filters');
        const filterBody = document.querySelector('.card-body');
        const filterIcon = document.getElementById('filter-icon');
        const filterText = document.getElementById('filter-text');
        
        if (toggleButton && filterBody) {
            toggleButton.addEventListener('click', function() {
                if (filterBody.style.display === 'none') {
                    filterBody.style.display = 'block';
                    filterIcon.className = 'bi bi-chevron-up';
                    filterText.textContent = 'Ocultar';
                } else {
                    filterBody.style.display = 'none';
                    filterIcon.className = 'bi bi-chevron-down';
                    filterText.textContent = 'Mostrar';
                }
            });
        }
    });
    
    // Confirmación para eliminar
    function confirmarEliminacion(mensaje) {
        return confirm(mensaje || '¿Está seguro de que desea eliminar este plazo?');
    }
    
    // Funcionalidad de selección de plazos
    const selectAllCheckbox = document.getElementById('select-all');
    const plazoCheckboxes = document.querySelectorAll('.plazo-checkbox');
    const selectedCountSpan = document.getElementById('selected-count');
    const exportSelectedPdfBtn = document.getElementById('export-selected-pdf');
    const exportSelectedIcsBtn = document.getElementById('export-selected-ics');
    const exportAllPdfBtn = document.getElementById('export-all-pdf');
    const exportAllIcsBtn = document.getElementById('export-all-ics');
    
    // Función para actualizar contador y botones
    function updateSelection() {
        const selectedCheckboxes = document.querySelectorAll('.plazo-checkbox:checked');
        const count = selectedCheckboxes.length;
        
        if (selectedCountSpan) {
            selectedCountSpan.textContent = count;
        }
        
        // Habilitar/deshabilitar botones
        if (exportSelectedPdfBtn) {
            exportSelectedPdfBtn.disabled = count === 0;
        }
        if (exportSelectedIcsBtn) {
            exportSelectedIcsBtn.disabled = count === 0;
        }
        
        // Actualizar estado del checkbox "Seleccionar todo"
        if (selectAllCheckbox) {
            if (count === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (count === plazoCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }
    }
    
    // Checkbox "Seleccionar todo"
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            plazoCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelection();
        });
    }
    
    // Checkboxes individuales
    plazoCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelection);
    });
    
    // Función para exportar plazos seleccionados
    function exportSelected(format) {
        const selectedCheckboxes = document.querySelectorAll('.plazo-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            alert('Por favor selecciona al menos un plazo para exportar.');
            return;
        }
        
        const params = new URLSearchParams();
        selectedIds.forEach(id => {
            params.append('plazos', id);
        });
        
        window.open(`/exportar/${format}/?${params.toString()}`, '_blank');
    }
    
    // Función para exportar todos los plazos
    function exportAll(format) {
        const currentParams = new URLSearchParams(window.location.search);
        window.open(`/exportar/${format}/?${currentParams.toString()}`, '_blank');
    }
    
    // Event listeners para botones de exportación
    if (exportSelectedPdfBtn) {
        exportSelectedPdfBtn.addEventListener('click', () => exportSelected('pdf'));
    }
    
    if (exportSelectedIcsBtn) {
        exportSelectedIcsBtn.addEventListener('click', () => exportSelected('ics'));
    }
    
    if (exportAllPdfBtn) {
        exportAllPdfBtn.addEventListener('click', () => exportAll('pdf'));
    }
    
    if (exportAllIcsBtn) {
        exportAllIcsBtn.addEventListener('click', () => exportAll('ics'));
    }
    
    // Inicializar estado
    updateSelection();
    
    // ===== BÚSQUEDA AVANZADA =====
    
    // Toggle para filtros avanzados
    const toggleAdvancedBtn = document.getElementById('toggle-advanced-filters');
    const advancedFilters = document.getElementById('advanced-filters');
    const advancedText = document.getElementById('advanced-text');
    
    if (toggleAdvancedBtn && advancedFilters) {
        toggleAdvancedBtn.addEventListener('click', function() {
            if (advancedFilters.style.display === 'none') {
                advancedFilters.style.display = 'block';
                advancedText.textContent = 'Ocultar opciones avanzadas';
                this.querySelector('i').className = 'bi bi-gear-fill';
            } else {
                advancedFilters.style.display = 'none';
                advancedText.textContent = 'Mostrar opciones avanzadas';
                this.querySelector('i').className = 'bi bi-gear';
            }
        });
    }
    
    // Atajos de teclado para búsqueda
    document.addEventListener('keydown', function(e) {
        // Ctrl + K para enfocar búsqueda
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            const searchInput = document.getElementById('busqueda-input');
            if (searchInput) {
                searchInput.focus();
            }
        }
        
        // Escape para limpiar búsqueda
        if (e.key === 'Escape') {
            const searchInput = document.getElementById('busqueda-input');
            if (searchInput) {
                searchInput.value = '';
                const searchResults = document.getElementById('search-results');
                if (searchResults) {
                    searchResults.style.display = 'none';
                }
            }
        }
    });
    
    // Mostrar tooltip de atajos
    const searchInput = document.getElementById('busqueda-input');
    if (searchInput) {
        searchInput.addEventListener('focus', function() {
            this.title = 'Presiona Ctrl+K para enfocar rápidamente';
        });
    }
</script>

<!-- Incluir JavaScript de búsqueda avanzada -->
<script src="{% static 'js/advanced-search.js' %}"></script>
{% endblock %}
